# NGINX MIME TYPE OVERRIDE FIX
# The issue is that nginx is setting both Content-Type headers
# We need to use more_clear_headers or proxy_hide_header to remove the default one

# SOLUTION 1: Use proxy_hide_header to remove the default Content-Type
location /cardcam/onnx/ {
    proxy_pass http://192.168.1.77:80/onnx/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Hide the default Content-Type from backend
    proxy_hide_header Content-Type;
    
    # Force MIME type for .mjs files
    if ($request_uri ~* \.mjs$) {
        add_header Content-Type "text/javascript" always;
    }
    
    # Set default Content-Type for other files
    if ($request_uri !~* \.(mjs|wasm)$) {
        add_header Content-Type "application/octet-stream" always;
    }
    
    # Force MIME type for .wasm files
    if ($request_uri ~* \.wasm$) {
        add_header Content-Type "application/wasm" always;
    }
    
    # Cache ONNX modules
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# SOLUTION 2: Use map directive (add this OUTSIDE the server block, at the top level)
# map $request_uri $onnx_content_type {
#     ~*\.mjs$    "text/javascript";
#     ~*\.wasm$   "application/wasm";
#     default     "application/octet-stream";
# }
#
# Then in the location block:
# location /cardcam/onnx/ {
#     proxy_pass http://192.168.1.77:80/onnx/;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     
#     proxy_hide_header Content-Type;
#     add_header Content-Type $onnx_content_type always;
#     
#     expires 1y;
#     add_header Cache-Control "public, immutable";
# }

# SOLUTION 3: Separate location blocks (most reliable)
# Handle .mjs files specifically
location ~ ^/cardcam/onnx/.*\.mjs$ {
    proxy_pass http://192.168.1.77:80;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_hide_header Content-Type;
    add_header Content-Type "text/javascript" always;
    add_header Access-Control-Allow-Origin "*" always;
    
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Handle .wasm files specifically  
location ~ ^/cardcam/onnx/.*\.wasm$ {
    proxy_pass http://192.168.1.77:80;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_hide_header Content-Type;
    add_header Content-Type "application/wasm" always;
    add_header Access-Control-Allow-Origin "*" always;
    
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# Handle other ONNX files
location /cardcam/onnx/ {
    proxy_pass http://192.168.1.77:80/onnx/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    expires 1y;
    add_header Cache-Control "public, immutable";
}
